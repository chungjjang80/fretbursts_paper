\section{Architecture and concepts}
\label{sec:concepts}

In this section we introduce some general concepts and naming conventions related
to the smFRET burst analysis in FRETBursts.

\subsection{Photon streams}
\label{sec:ph_streams}

The fundamental data at the core of smFRET experiments is the array of photon
arrival timestamps, with a temporal resolution set by the acquisition hardware,
ranging from below nanoseconds to a few tens of nanoseconds.
In single-spot
measurements, all timestamps are stored in a single array. In multi-spot
measurements~\cite{Ingargiola_2013}, there are as many timestamps arrays
as excitation spots.

Each array contains timestamps from both donor (D) and acceptor (A) channels.
In ALEX measurements~\cite{Lee_2005}, we can further differentiate between
photons emitted during D and A excitation periods. In FRETBursts the different
selections of photons/timestamps are called "photon streams" and they are
specified with a
\href{http://fretbursts.readthedocs.org/en/latest/ph_sel.html}{\texttt{Ph\_sel}
object} . In non-ALEX smFRET data there are 3 photon streams
(table~\ref{tab:ph_sel_smfret}), while in ALEX data we have 5 base photon
streams (table~\ref{tab:ph_sel_alex}).

The
\href{http://fretbursts.readthedocs.org/en/latest/ph_sel.html}{\texttt{Ph\_sel}
class} allows the expression of any combination of photon streams.
For example, in ALEX measurements, the D-emission during A-excitation stream is
usually excluded because it does not contain any useful signal~\cite{Lee_2005}.
To indicate all but the photons in this photon stream we write
\verb|Ph_sel(Dex='DAem', Aex='Aem')|, which literally means \textit{select donor
and acceptor photons (DAem) during donor excitation (Dex) and only acceptor
photons (Aem) during acceptor excitation (Aex)}.

\begin{table}
\begin{tabular}{l|l}
  Photon selection  & code \\
  \hline
  All-photons       & \verb|Ph_sel('all')|\\
  D-emission    & \verb|Ph_sel(Dex='Dem')|\\
  A-emission & \verb|Ph_sel(Dex='Aem')|\\
\end{tabular}
\caption{\label{tab:ph_sel_smfret}Photon selection syntax (non-ALEX)}
\end{table}

\begin{table}
\begin{tabular}{l|l}
  Photon selection  & code \\
  \hline
  All-photons & \verb|Ph_sel('all')|\\
  D-emission during D-excitation & \verb|Ph_sel(Dex='Dem')|\\
  A-emission during D-excitation & \verb|Ph_sel(Dex='Aem')|\\
  D-emission during A-excitation & \verb|Ph_sel(Aex='Dem')|\\
  A-emission during A-excitation & \verb|Ph_sel(Aex='Aem')|\\
\end{tabular}
\caption{\label{tab:ph_sel_alex}Photon selection syntax (ALEX)}
\end{table}

\subsection{Background definitions}
\label{sec:bg_intro}

An estimation of the background rates is needed both to select a proper threshold for
burst search and to correct the raw burst counts by subtracting the background counts.

The recorded stream of timestamps is the result of two processes: one characterized
by a high count rate, due to fluorescence photons of single molecules crossing the
excitation volume, and another one characterized by a lower count rate due to “background
counts” originating from the detectors dark counts, out of focus molecules
and sample scattering and/or auto-fluorescence\cite{Gopich_2008}.
The signature of those two processes can be
observed in the distribution of timestamp delays (i.e. the waiting times
between two subsequent timestamps) as illustrated in Figure~\ref{fig:bgdist}.
The “tail” of the distribution (a straight line in semi-log scale) corresponds
to exponentially-distributed delays, indicating that those counts are generated by a
\href{http://en.wikipedia.org/wiki/Poisson_process}{Poisson process}. At short
timescales, the distribution departs from exponential behavior due to the contribution
of the higher rate process of single molecules traversing the excitation volume.
To estimate the background rate, (i.e. the exponential time constant)
it is necessary to define a delay threshold, above which the distribution
can be considered exponential.
Next a fitting method, for example the Maximum
Likelihood Estimation (MLE) or a curve fit of the histogram via non-linear
least squares (NLSQ) must be selected.

It is advisable to check the background at different time points
throughout the measurements in order to track occasional variations.
Experimentally we found that when the background is not constant,
it usually varies
on time scales of tens of seconds (see figure~\ref{fig:bg_timetrace}).
FRETBursts splits the data in uniform time
slices called \textit{background periods} and computes the background rates for
each of these slices (see section~\ref{sec:bg_calc}).
Note that the division in background periods is also used during
burst search to compute a background-dependent
threshold and to apply the burst correction (section~\ref{sec:burstsearch}).

\subsection{The \texttt{Data} class}
\label{sec:data_intro}

The
\href{http://fretbursts.readthedocs.org/en/latest/data_class.html}{\texttt{Data}
class} is the fundamental data container in FRETBursts. It contains the
measurement data and provides several methods for data analysis (background
estimation, burst search, etc...). It also stores all analysis results
(bursts data, estimated parameters).

A few examples of some some important burst-data fields are listed next:

\begin{itemize}
\item \verb|nd|: number of photons detected by the donor channel
(during donor excitation period, if ALEX)
\item \verb|na|: number of photons detected by the acceptor channel
(during donor excitation period, if ALEX)
\item \verb|naa|: number of photons detected by the acceptor channel
during acceptor excitation period (present only in ALEX measurements)
\end{itemize}

The previous fields are background-corrected by default. Furthermore,
\verb|na| is corrected for leakage and direct excitation if the
relative coefficients are specified (by default they are 0).

\paragraph{Python details}

Most arrays in \texttt{Data} are contained in lists with lengths equal to the
number of excitation spots. This means that in
single-spot measurements, to access the array for some burst-data
we have to specify the 0 index, for example \verb|Data.nd[0]|.
\verb|Data| implements a shortcut syntax to access the first element of a list
with an underscore, so we can type
\verb|Data.nd_| instead of accessing \verb|Data.nd|.

\subsection{Introduction to burst search}
\label{sec:burstsearch_intro}

Identifying single-molecule bursts in the stream of photons is
one of the most crucial steps in the analysis of freely-diffusing single-molecule measurement data.
The widely used "sliding window" algorithm, introduced by the Seidel group in 1998
(\cite{Eggeling_1998}, \cite{Fries_1998}), involves searching for
$m$ consecutive photons detected during a period shorter than
$\Delta t$. In other words, bursts are regions of the photon stream where the
local rate (computed using $m$ photons) is above a minimal rate chosen as a
threshold. Eggeling did not provide any criteria on how to choose the rate
threshold and the number of photons $m$ and as therefore it has become a common
practice to manually adjust those parameters for each specific measurement.

A more general approach consists in taking into account the background rate of
the specific measurements and in choosing a rate threshold that is $F$ times
larger than the background rate. This approach assures that all the resulting bursts
have a signal-to-background ratio (SBR) larger than
$(F-1)$~\cite{Michalet_2012}. A consistent criterion for choosing the threshold is
very important when comparing different measurements with different background
rates, when the background significantly varies during measurements or in
multi-spot measurements where each spot has a different background rate.

A second important aspect of burst search is the choice of photon stream used
to perform the search.
In most cases, for instance when identifying FRET populations,
the burst search should use all photons. In some other cases, when focusing on
donor-only or acceptor only populations, it is better to perform the search using
only donor or acceptor signal.
In order to handle the general case and to provide flexibility,
FRETBursts allows to perform the burst search on arbitrary selections of photons.
(see section~\ref{sec:ph_streams} for more info on photon stream definitions).

Finally, Nir~\textit{et al.}~\cite{Nir_2006} proposed a Dual-Channel Burst
Search (DCBS), which can help mitigating artifacts due to
photo-physical effects such as blinking. In this case a search is performed
independently on two photon streams and bursts are marked only when both photon
streams exhibit a rate higher than the threshold,
implementing an AND gate logic.
Usually, the term DCBS refers to a burst search where the two photon streams
are (1) all photons
during donor excitation (\verb|Ph_sel(Dex='DAem')|) and (2) acceptor channel photons
during acceptor
excitation (\verb|Ph_sel(Aex='Aem')|).

After each burst search, it is useful to select
bursts having a minimum number of photons (burst size). In the most
basic form, this selection can be performed during burst search by discarding
bursts with size smaller than a threshold $L$, as originally proposed by
Eggeling~\textit{et al.}~\cite{Eggeling_1998}.
This method, however, neglects the effect
of background and gamma factor on the burst size and can lead to a selection
bias of certain channels and/or sub-populations.
For this reason we advocate performing a burst size selection after background
correction and taking into account the gamma factor, as discussed in
section~\ref{sec:burstsel}.


\subsection{Burst weights}

As will be shown in the following sections, the burst search returns bursts of different sizes (i.e. number of photons).
Bursts with large size (that indeed contain most of the information)
are much less frequent than bursts with smaller sizes. For this reason, in order
to resolve FRET populations and accurately assess their mean FRET efficiency, it is of
paramount importance to select bursts with size larger than a given threshold (see
section~\ref{sec:burstsel}). The choice of burst size threshold is
critical because too low threshold will for instance widen FRET histogram peaks owing to the
inclusion of small sized bursts having higher FRET uncertainty. Conversely
too high threshold will result in a lower number of bursts and FRET estimation
can suffer from poor statistics.

In order to mitigate the dependence on the burst size threshold it may be
useful to weight bursts according to their size (i.e. their
information content) so that the biggest bursts will have the highest weights.
The weighting can be used to build weighted histograms and Kernel Density Estimation (KDE) plots.
When using weights, the choice of a particular burst size threshold becomes
much less important and the histograms or KDE plots exhibit minimal-width
peaks corresponding to different FRET populations for a much wider range
of thresholds.

FRETBursts allows weighting bursts using the gamma-corrected burst size
(\verb|gamma*nd + na|) and optionally adding the acceptor counts during
acceptor excitation ((\verb|gamma*nd + na + naa|). Once the size is defined, the weights
can be computed according to different formulas. The most
commonly used is \verb|'size'|, meaning that the weight
is proportional to the burst size. The list of weight types
can be found in the
\href{http://fretbursts.readthedocs.org/en/latest/fret_fit.html#fretbursts.fret_fit.get_weights}{\texttt{fret\_fit.get\_weights} documentation}.

\subsection{Plotting "Data"}
\label{sec:plotting}

FRETBursts uses 
matplotlib~\cite{2096e2a4-8f50-4519-bfb3-f796da201630}
and seaborn~\cite{7d9c2aad-1e9a-4098-bec5-38ab80b85d7e} 
to provide a wide range of
\href{http://fretbursts.readthedocs.org/en/latest/plots.html}{built-in plot functions}
for \verb|Data| objects.
The plot syntax is the same for both single and multi-spot measurements.
The majority of plot commands are called through the wrapper function
\verb|dplot|, for example to plot a timetrace of the photon data, type:

\begin{verbatim}
dplot(d, timetrace)
\end{verbatim}

The function \verb|dplot| is the generic plot function which creates figure
and handles details common to all the plotting functions (for instance the title).
\verb|d| is the \verb|Data| variable and \verb|timetrace| is the actual plot
function which operates on a single channel. In multi-spot measurements
\verb|dplot| creates one subplot for each spot and calls \verb|timetrace| for
each channel.

All built-in plot functions which can be passed to
\verb|dplot| are defined in the
\href{http://fretbursts.readthedocs.org/en/latest/plots.html}{\texttt{burst\_plot} module}.

\paragraph{Python details}

When FRETbursts is imported, all the plot functions are also imported.
To facilitate finding the plot functions through auto-completion,
their names start with a standard prefix indicating the
plot type. The prefixes are: \verb|timetrace| for binned timetraces
of photon data, \verb|ratetrace| for rates of photons as a function of time (non
binnned), \verb|hist| for functions plotting histograms and \verb|scatter| for
scatter plots.

Additional plots can be easily created directly with matplotlib.

By default, in order to speed-up batch processing, FRETBursts notebooks display plots 
as static images using the \textit{inline} matplotlib backend. 
User can choose switch to interactive figures by using an interactive backend. 
For example \verb|%matplotlib notebook| 
provides interactive figures inside the browser, 
and \verb|%matplotlib qt| 
for interactive figures in a new window (using the QT4 graphical library).

A few plot functions such as \verb|timetrace| and \verb|hist2d_alex| have interactive features 
which require the QT4 backend. As an example, after switching to the QT4 backend
the following command:

\begin{verbatim}
dplot(d, timetrace, scroll=True, bursts=True)
\end{verbatim}

\noindent
will open a new window with a timetrace plot with overlay of bursts, and an horizontal scroll-bar for quick
"scrolling" throughout the measurement. The user can click on a burst to have the corresponding burst info 
printed in the notebooks.
Similarly, calling the \verb|hist2d_alex| function with the QT4 backend allows
selecting an area on the E-S histogram using the mouse.

\begin{verbatim}
dplot(ds, hist2d_alex, gui_sel=True)
\end{verbatim}

The values that identify the region are printed in the notebook and can be used 
to select bursts inside the region with the function \verb|select_bursts.ES| (see
section~\ref{sec:burstsel}).
