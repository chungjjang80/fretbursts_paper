\subsection{Background estimation}
\label{sec:bg_calc}

The first step of smFRET analysis involves estimating background rates.
For example, to compute the background every 30 s, using a minimal inter-photon
delay threshold of 2~ms for all the photon, we use:

\begin{lstlisting}
d.calc_bg(bg.exp_fit, time_s=30, tail_min_us=2000)
\end{lstlisting}

The first argument (\verb|bg.exp_fit|) is the underlying function used to fit the
background in each period and for each photon stream (see section~\ref{sec:bg_intro}).
The function
\verb|bg.exp_fit| estimates the background using a maximum likelihood estimation
(MLE) of the delays distribution. Additional fitting functions are available in
\verb|bg| namespace 
(i.e. the \verb|background| modulw, \href{http://fretbursts.readthedocs.org/en/latest/background.html}
{link}). The second argument, \verb|time_s|, is the
\textit{background period} (section~\ref{sec:bg_intro}) and the third, \verb|tail_min_us|,
is the inter-photon delay threshold above which the distribution is assumed exponential.
It is possible to use different thresholds for each photon stream, passing a
tuple (i.e. a comma-separated list of values, \href{https://docs.python.org/3.5/tutorial/datastructures.html#tuples-and-sequences}{link}) instead of a scalar.

Finally, it is possible to use a heuristic estimation of the threshold using
\verb|tail_min_us='auto'|. For more details refer to the \verb|calc_bg| documentation
(\href{http://fretbursts.readthedocs.org/en/latest/data\_class.html#fretbursts.burstlib.Data.calc_bg}{link}).

After the background has been estimated, it is useful to compare the histogram of 
inter-photon delays with an the fitted exponential distribution as shown in figure~\ref{fig:bg_dist_all}
(see section~\ref{sec:bg_intro}). This plot is performed with:

\begin{lstlisting}
dplot(d, hist_bg, bp=0)
\end{lstlisting}

The argument \verb|bp| is an integer specifying the background period to be plotted.
When not specified the default is 0, i.e. the first period.
Figure~\ref{fig:bg_dist_all} allows to quickly identify pathological cases when the 
background fitting procedure returns unreasonable values. 

Another useful plot is the timetrace of the estimated background, as shown in 
figure~\ref{fig:bg_timetrace}. This plot allows to monitor background changes
taking place during the measurement. In our experience, coverglass impurities
can contribute to the background even when focusing deep into the sample (10um or more),
and these impurities tend to bleach on timescales of minutes resulting in
background variations such as the one shown in figure~\ref{fig:bg_timetrace}a.
Another source of background variation, visible in figure~\ref{fig:bg_timetrace}b, is 
the evaporation in case the sample is placed on the coverglass without an enclosure (gasket).

\paragraph{Python details} For an ALEX measurement, the tuple passed to
\verb|tail_min_us| to define the thresholds, is required to have have 
5 values corresponding the 5 photon streams. 
The ordering of the photon streams can be obtained from
the \verb|Data.ph_streams| attributes (i.e. \verb|d.ph_streams| in our example).
The estimated background rates are stored in the \verb|Data| attributes
\verb|bg_dd|, \verb|bg_ad| and \verb|bg_aa|, corresponding to the photon
streams \verb|Ph_sel(Dex='Dem')|, \verb|Ph_sel(Dex='Aem')| and \verb|Ph_sel(Aex='Aem')|
respectively. These attributes are lists of arrays (one array per excitation spot).
The arrays contain the estimated background rates in the different background periods.


\subsubsection{Error metric and optimal threshold}

The functions that fit the background also return an estimation of the
quality of the fit, computed as the distance between the empirical
\href{http://en.wikipedia.org/wiki/Cumulative\_distribution\_function}{cumulative distribution function}
(CDF) and fitted CDF. Two different distance metrics can be returned.
The first is the
\href{http://en.wikipedia.org/wiki/Kolmogorov\%E2\%80\%93Smirnov\_test}{Kolgomorov-Smirnov}
statistics (the maximum of the difference between the empirical and the
fitted CDF) and the second is the
\href{http://en.wikipedia.org/wiki/Cram\%C3\%A9r\%E2\%80\%93von\_Mises\_criterion}{Cram√©r von Mises}
statistics corresponding to the integral of the squared residuals
(see the code
\href{https://github.com/tritemio/FRETBursts/blob/master/fretbursts/background.py#L41}{here}).

In principle, the optimal threshold minimizes
the error metric. This approach is implemented by the function
\href{http://fretbursts.readthedocs.org/en/latest/plugins.html#fretbursts.burstlib\_ext.calc\_bg\_brute}{calc\_bg\_brute}
in the
\href{http://fretbursts.readthedocs.org/en/latest/plugins.html}{burstlib\_ext module} and can be used
in cases when a user wants to extract the most accurate estimation of background rates.
